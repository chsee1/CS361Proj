<section class="welcome">
  <h2>Hi, <%= user.username %>!</h2>
  <p>Welcome back to your meal planning dashboard.</p>
</section>

<section class="dashboard-content">

  <!-- Top Row: Weekly Progress + Quick Actions -->
  <div class="dashboard-top-row">
    <div id="quote-box" >
      <p id="quote-text"></p>
    </div>

    <!-- Weekly Progress -->
    <div class="card">
      <h3>Weekly Progress</h3>
      <div class="progress-charts">
        <div class="circle-chart">
          <div class="circle-text"><%= user.stats.adherence %>%</div>
          <div class="circle-label">Adherence</div>
        </div>
        <div class="circle-chart">
          <div class="circle-text"><%= user.stats.nutrition %>%</div>
          <div class="circle-label">Nutrition</div>
        </div>
      </div>

      <div class="macro-grid">
        <div><strong>Calories</strong><br><%= user.stats.calories.current %>/2000</div>
        <div><strong>Protein</strong><br><%= user.stats.protein.current %>g</div>
        <div><strong>Carbs</strong><br><%= user.stats.carbs.current %>g</div>
        <div><strong>Fat</strong><br><%= user.stats.fat.current %>g</div>
      </div>
    </div>

    <!-- Quick Actions -->
    <div class="card">
      <h3>Quick Actions</h3>
      <div class="quick-actions">
        <a href="/generate" class="btn-secondary">Generate Meal Plan</a>
        <a href="/preferences" class="btn-secondary">Update Preferences</a>
        <a href="/suggestions" class="btn-secondary">Browse Suggestions</a>
        <a href="/weekly" class="btn-primary">View Weekly Plan</a>
      </div>
    </div>
  </div>

  <% 
  const b = meals.find(m => m.type === "Breakfast");
  const l = meals.find(m => m.type === "Lunch");
  const d = meals.find(m => m.type === "Dinner");
%>
<div class="card todays-meals">
  <h3>Today's Meals</h3>
  <div class="meal-grid">
    <% [b, l, d].forEach(meal => { %>
      <div class="meal-card">
        <small><%= meal.type %></small>
        <a href="/recipe?id=<%= meal.id %>" class="meal-card">
          <img src="<%= meal.image %>" alt="<%= meal.name %>">
          <h4><%= meal.name %></h4>
          <p><%= meal.calories %> cal</p>
          <p><%= meal.protein %>g protein</p>
        </a>
      </div>
    <% }); %>
  </div>
</div>



<!-- Favorite Meals Section -->
<div class="card dashboard-card full-width">
  <h3>Favorite Meals</h3>

  <% if (recentFavorites && recentFavorites.length > 0) { %>
    <div class="meal-grid">
      <% recentFavorites.forEach(fav => { %>
        <div class="meal-card">
          <a href="/recipe?id=<%= fav.id %>" class="meal-card">
          <img src="<%= fav.image %>" alt="<%= fav.name %>">
          <h4><%= fav.name %></h4>
          <p><%= fav.calories %> cal</p>
          <p><%= fav.protein %>g protein</p>
          <form class="remove-favorite-form" data-id="<%= fav.id %>">
          <button type="submit" class="btn-secondary">Remove</button>
          </form>
          </a>
        </div>
      <% }) %>
    </div>
  <% } else { %>
    <p>You have no favorites right now! Favorite a meal to see it here.</p>
  <% } %>
</div>

</div>


</section>

<script>
document.querySelectorAll(".remove-favorite-form").forEach(form => {
  form.addEventListener("submit", async (e) => {
    e.preventDefault();
    const mealId = form.dataset.id;
    const userId = 1; // static for now

    const res = await fetch(`/api/favorites/${userId}/${mealId}`, {
      method: "DELETE"
    });

    if (res.ok) {
      alert("✅ Favorite removed");
      window.location.reload();
    } else {
      alert("❌ Failed to remove favorite");
    }
  });
});
</script>
